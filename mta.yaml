_schema-version: "3.2"
ID: btp-api
version: 1.0.0
description: "SAP BTP Vendor Dashboard with In-Memory Settings"

parameters:
  enable-parallel-deployments: true

build-parameters:
  before-all:
    - builder: custom
      commands:
        - npm ci
        - npx cds build --production

# ═══════════════════════════════════════════════════════════
# MODULES
# ═══════════════════════════════════════════════════════════
modules:

  # ─── Backend Service ───────────────────────────────────
  - name: btp-api-srv
    type: nodejs
    path: gen/srv
    parameters:
      buildpack: nodejs_buildpack
      memory: 256M
      disk-quota: 512M
    build-parameters:
      builder: npm
    provides:
      - name: srv-api
        properties:
          srv-url: "${default-url}"
    requires:
      - name: btp-api-auth
      - name: btp-api-destination
      - name: btp-api-connectivity
      # HANA DB Kaldırıldı (Hesapta yok)

  # ─── AppRouter ──────────────────────────────────────────
  - name: btp-api-approuter
    type: approuter.nodejs
    path: app/vendor-open-items
    parameters:
      buildpack: nodejs_buildpack
      memory: 128M
    build-parameters:
      builder: npm
    requires:
      - name: srv-api
        group: destinations
        properties:
          name: srv-api
          url: "~{srv-url}"
          forwardAuthToken: true
      - name: btp-api-auth

# ═══════════════════════════════════════════════════════════
# RESOURCES
# ═══════════════════════════════════════════════════════════
resources:
  - name: btp-api-auth
    type: org.cloudfoundry.managed-service
    parameters:
      service: xsuaa
      service-plan: application
      path: ./xs-security.json
      config:
        xsappname: btp-api-${org}-${space}
        tenant-mode: dedicated
        scopes:
          - name: "$XSAPPNAME.admin"
            description: "Admin Access"
        role-templates:
          - name: "AdminRole"
            description: "Admin Role"
            scope-references:
              - "$XSAPPNAME.admin"
        role-collections:
          - name: "btp-api-admin"
            description: "Admin Role Collection"
            role-template-references:
              - "$XSAPPNAME.AdminRole"

  - name: btp-api-destination
    type: org.cloudfoundry.managed-service
    parameters:
      service: destination
      service-plan: lite

  - name: btp-api-connectivity
    type: org.cloudfoundry.managed-service
    parameters:
      service: connectivity
      service-plan: lite
